{
  "name": "refresh_store",
  "description": "Daily trigger that downloads packs and extensions from official Saltcorn Store (https://store.saltcorn.com) and calls update_ext/update_pack to refresh data in local tables for public plugins/packs.",
  "action": "blocks",
  "when_trigger": "Daily",
  "channel": null,
  "min_role": 1,
  "configuration": {
    "code": "var packs, exts, pack_row, ext_row;\r\n\r\n\r\n// Refresh packs\r\nif (true) {\r\n  packs = (await fetchJSON('https://store.saltcorn.com/api/packs', { method: 'GET' }));\r\n  console.log((['Got ',(packs.success).length,'packs from upstream'].join('')));\r\n  if (!(packs.success)) {\r\n    console.log(('Error downloading packs: ' + String(packs.error)));\r\n  } else {\r\n    var pack_row_list = (packs.success);\r\n    for (var pack_row_index in pack_row_list) {\r\n      pack_row = pack_row_list[pack_row_index];\r\n      console.log(('Installing pack ' + String(pack_row.name)));\r\n      console.log((packs.constructor.name && Actions.update_pack({body:pack_row})));\r\n    }\r\n  }\r\n}\r\n// Refresh plugins\r\nif (true) {\r\n  exts = (await fetchJSON('https://store.saltcorn.com/api/extensions', { method: 'GET' }));\r\n  console.log((['Got ',(exts.success).length,'plugins from upstream'].join('')));\r\n  if (!(exts.success)) {\r\n    console.log(('Error downloading extensions: ' + String(exts.error)));\r\n  } else {\r\n    var ext_row_list = (exts.success);\r\n    for (var ext_row_index in ext_row_list) {\r\n      ext_row = ext_row_list[ext_row_index];\r\n      console.log(('Installing plugin ' + String(ext_row.name)));\r\n      console.log((exts.constructor.name && Actions.update_ext({body:ext_row})));\r\n    }\r\n  }\r\n}\r\n",
    "workspace": "<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</variable><variable id=\"qDSPT89$=2k|+c3],x.R\">exts</variable><variable id=\"sYgRL?mVA-6upTlp9Yl{\">pack_row</variable><variable id=\"/$P=:tDNsdPWT}DwQ#@@\">ext_row</variable></variables><block type=\"controls_if\" id=\"PI5n;jj#LdTa_6ydf~r%\" collapsed=\"true\" x=\"58\" y=\"21\"><comment pinned=\"false\" h=\"80\" w=\"160\">Refresh packs</comment><value name=\"IF0\"><block type=\"logic_boolean\" id=\"O*qS-M%4PTQG]*A[P1[2\"><field name=\"BOOL\">TRUE</field></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"Iu[XWth.-!c2#yT)`o9g\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field><value name=\"VALUE\"><block type=\"http_request\" id=\"G6t~sYLO4#7I.L{.^am9\"><field name=\"METHOD\">GET</field><value name=\"URL\"><block type=\"text\" id=\"%gfbG#H|q~3oex$IDt-f\"><field name=\"TEXT\">https://store.saltcorn.com/api/packs</field></block></value></block></value><next><block type=\"console\" id=\"9hi_)h0CfsXlEu3@KsQz\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"6^C,Gm?-E%mANtNz$yJG\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"l8h~JKe[eRK6/HiJ*y$w\"><field name=\"TEXT\">Got </field></block></value><value name=\"ADD1\"><block type=\"lists_length\" id=\"FXey,qd2k0IK:Ew,cwjZ\"><value name=\"VALUE\"><block type=\"row_get\" id=\"*up^8v-=,6ckj%Kh#l7S\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\"KbODxE-+VKN0}oL:Zbx/\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field></block></value></block></value></block></value><value name=\"ADD2\"><block type=\"text\" id=\",?Atpu_*eQ;v7vGhp49*\"><field name=\"TEXT\">packs from upstream</field></block></value></block></value><next><block type=\"controls_if\" id=\"@{KE]JMskir/ph_)KF8l\"><mutation else=\"1\"></mutation><value name=\"IF0\"><block type=\"logic_negate\" id=\".P=f+WVlmI0rXE}wFRU0\"><value name=\"BOOL\"><block type=\"row_get\" id=\"pnN,nN|AxedM0P)U2d9Z\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\"DZE31vc|vyGG)GpauD_l\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"console\" id=\"2FJTtMrJ0qBi^R7,n4`U\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"pj4pCT@d)uoVVq`r%~lC\" inline=\"false\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"r?I66wtCX~{25x$q@aWV\"><field name=\"TEXT\">Error downloading packs: </field></block></value><value name=\"ADD1\"><block type=\"row_get\" id=\"Kn$sJNWfoDCqwAuAqp-q\"><field name=\"KEY\">error</field><value name=\"ROW\"><block type=\"variables_get\" id=\"cg}F2NzFzwIN$X?LNrQT\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field></block></value></block></value></block></value></block></statement><statement name=\"ELSE\"><block type=\"controls_forEach\" id=\"A;xRrR$5V!j1oZ@8iPDF\"><field name=\"VAR\" id=\"sYgRL?mVA-6upTlp9Yl{\">pack_row</field><value name=\"LIST\"><block type=\"row_get\" id=\"w}Xr3+*ghfAF!6;VoJwX\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\"R@(S!tPlH,7X4a=5$dz9\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field></block></value></block></value><statement name=\"DO\"><block type=\"console\" id=\"ENo/ii#pXe_/BEsue2Tz\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"E?OtU(blW}+m_$%Xrv)_\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"hQ~V9P]Z56apc-*Ay?Z4\"><field name=\"TEXT\">Installing pack </field></block></value><value name=\"ADD1\"><block type=\"row_get\" id=\"KUJO}MDg+qwkW~Li|-9!\"><field name=\"KEY\">name</field><value name=\"ROW\"><block type=\"variables_get\" id=\"5#dQ1[o}j{kd7^+ap3vO\"><field name=\"VAR\" id=\"sYgRL?mVA-6upTlp9Yl{\">pack_row</field></block></value></block></value></block></value><next><block type=\"console\" id=\"LlC=m0u+x*fLR|dEM43j\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"row_get\" id=\"?+).-z|oX2HM3aiKf|4:\"><field name=\"KEY\">constructor.name &amp;&amp; Actions.update_pack({body:pack_row})</field><value name=\"ROW\"><block type=\"variables_get\" id=\"$PR2vmG@4U+Eo7m;OZiz\"><field name=\"VAR\" id=\"+r$G35gMB4Dz-1sx!;Wy\">packs</field></block></value></block></value></block></next></block></statement></block></statement></block></next></block></next></block></statement><next><block type=\"controls_if\" id=\"Gi@-7G_@Ous|RHOW?)N!\" collapsed=\"true\"><comment pinned=\"false\" h=\"80\" w=\"160\">Refresh plugins</comment><value name=\"IF0\"><block type=\"logic_boolean\" id=\"edN8r2j,*U*n*u4C#t1A\"><field name=\"BOOL\">TRUE</field></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"o`D/^izG,5iaR.4QKEMa\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field><value name=\"VALUE\"><block type=\"http_request\" id=\"a9=g|aYqYJy2u-^ue$kN\"><field name=\"METHOD\">GET</field><value name=\"URL\"><block type=\"text\" id=\"x+OdF{-s:1Mq54=m{}32\"><field name=\"TEXT\">https://store.saltcorn.com/api/extensions</field></block></value></block></value><next><block type=\"console\" id=\"PsVA|rC%yy}Y9r.!u1gq\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"hFk~1EZMwJe7Tz;@}4o|\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"Bi*a+8m/lG_$/pk=FTdW\"><field name=\"TEXT\">Got </field></block></value><value name=\"ADD1\"><block type=\"lists_length\" id=\"Pg/iRXZus)*ErwL/7`:^\"><value name=\"VALUE\"><block type=\"row_get\" id=\"=4-eP0YVko@oT5B8j6Lb\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\"SY2~pfq[=h=z-LSD*}!1\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field></block></value></block></value></block></value><value name=\"ADD2\"><block type=\"text\" id=\"{a*axZO%lf/DHne.+Kgh\"><field name=\"TEXT\">plugins from upstream</field></block></value></block></value><next><block type=\"controls_if\" id=\"N^+*R6cWwH82`#d!6kjG\"><mutation else=\"1\"></mutation><value name=\"IF0\"><block type=\"logic_negate\" id=\";bVETZzfyT4*Pi4/`l-I\"><value name=\"BOOL\"><block type=\"row_get\" id=\"H38B~fr$SFxIVXuTRy]4\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\"iJ_S.sD;;8:WiSljC9O-\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"console\" id=\"-2X]^7J_0xQ5QH3[-sgl\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"Ox~*L6Gu|rv$neZ^R2q]\" inline=\"false\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"9EEIisoCGSq|07U2_xx=\"><field name=\"TEXT\">Error downloading extensions: </field></block></value><value name=\"ADD1\"><block type=\"row_get\" id=\"FH|ZDM(0!sWzq`:2MvHx\"><field name=\"KEY\">error</field><value name=\"ROW\"><block type=\"variables_get\" id=\"GoOG^)a~{MS):(8qj}hC\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field></block></value></block></value></block></value></block></statement><statement name=\"ELSE\"><block type=\"controls_forEach\" id=\"E7|)7xLycOom;(hv.4T}\"><field name=\"VAR\" id=\"/$P=:tDNsdPWT}DwQ#@@\">ext_row</field><value name=\"LIST\"><block type=\"row_get\" id=\"1q#,l`?2GQOuiu,58sP^\"><field name=\"KEY\">success</field><value name=\"ROW\"><block type=\"variables_get\" id=\",#iZZ/9n|jzJW2[.X1j4\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field></block></value></block></value><statement name=\"DO\"><block type=\"console\" id=\"#IV2xut7xWCpI@{_DEFx\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"text_join\" id=\"_ab?A_S]]HkD39v:D07?\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><block type=\"text\" id=\"|Y02R3wfcS3oBI*;Q/{$\"><field name=\"TEXT\">Installing plugin </field></block></value><value name=\"ADD1\"><block type=\"row_get\" id=\"[O!20uh.BHgMm8ek?Vrm\"><field name=\"KEY\">name</field><value name=\"ROW\"><block type=\"variables_get\" id=\"dSO9(K]{}(w7OXIy-NGT\"><field name=\"VAR\" id=\"/$P=:tDNsdPWT}DwQ#@@\">ext_row</field></block></value></block></value></block></value><next><block type=\"console\" id=\"MmEhM%*czn:A!Sa5dkZ!\"><field name=\"STRING\">Console</field><value name=\"STRING\"><block type=\"row_get\" id=\"aLBk/dL2UQ$fT)TTTtj4\"><field name=\"KEY\">constructor.name &amp;&amp; Actions.update_ext({body:ext_row})</field><value name=\"ROW\"><block type=\"variables_get\" id=\"V#dz=){H6p]V19=oKibu\"><field name=\"VAR\" id=\"qDSPT89$=2k|+c3],x.R\">exts</field></block></value></block></value></block></next></block></statement></block></statement></block></next></block></next></block></statement></block></next></block></xml>"
  }
}
